# Lab 2 — Подключение бота к данным (CSV)  

**University:** ITMO University  
**Faculty:** FICT  
**Course:** Vibe Coding: AI-боты для бизнеса  
**Year:** 2025/2026  
**Group:** U4225  
**Author:** Нохрин Валерий Витальевич  
**Lab:** Lab2  
**Date of create:** 2025-10-28  
**Date of finished:** 

---

## 1. Коротко о решении
Бот Telegram (python-telegram-bot 21.x) подключён к файловому хранилищу CSV и умеет:
- принимать заявки от клиента (ФИО, email, пол, согласие на ОПП, выдача ссылки на курс);
- записывать заявки в `lab2/data/leads.csv`;
- показывать админские команды: `/inbox`, `/find <текст>`, `/set_status <id> <new|in_work|done|rejected>`;
- выгружать заявки в CSV-файл, который корректно открывается в Excel — команда `/export_csv`.

Интеграция соответствует варианту *«Работа с файлами (CSV/Excel)»* из методички по ЛР2. :contentReference[oaicite:0]{index=0}

---

## 2. Источник и структура данных
**Источник:** локальные CSV в папке `lab2/data/`.

**Файл:** `lab2/data/leads.csv`  
**Колонки (порядок):**
1. `id` — автоинкремент (int)  
2. `user_name` — имя в TG (str)  
3. `fio` — ФИО (str)  
4. `email` — Email (str)  
5. `topic` — тема (str)  
6. `status` — `new|in_work|done|rejected` (str)  
7. `details` — произвольный текст (str)  
8. `created_at` — ISO-дата/время (str)

Экспорт создаётся как `lab2/data/export/leads_YYYY-MM-DD_HHMMSS.csv` и открывается в Excel по столбцам (разделитель `,`, кодировка UTF-8-BOM).

---

## 3. Команды бота
**Клиент:**
- `/start` — воронка: согласие на ОПП → ФИО → email → пол → выдача `COURSE_URL`, запись в `leads.csv`.

**Админ (по `ADMIN_TELEGRAM_ID`):**
- `/inbox` — последние 10 заявок (id, ФИО, email, статус, дата).
- `/find <текст>` — поиск по ФИО/email/теме/деталям.
- `/set_status <id> <new|in_work|done|rejected>` — смена статуса.
- `/export_csv` — выгрузка в CSV и отправка файла.

---

## 4. Архитектура и файлы
repo-root/
.env
lab1/
bot/main.py # код бота (ЛР1+ЛР2)
lab2/
data/
leads.csv # база заявок
export/ # папка для выгрузок
files_io.py # работа с CSV: add_lead/list_leads/find_leads/set_status/export_csv
init.py
lab2_report.md # этот отчёт
README.md

---

## 5. Ключевые фрагменты (ссылочно)
- **Чтение/запись CSV** (`lab2/files_io.py`): функции `add_lead`, `list_leads`, `find_leads`, `set_status`, `export_csv` (разделитель `,`, `encoding="utf-8-sig"` для Excel).
- **Админ-команды** (`lab1/bot/main.py`): хэндлеры `/inbox`, `/find`, `/set_status`, `/export_csv`.
- **Защита админки:** проверка `is_admin(update.effective_user.id)` против `ADMIN_TELEGRAM_ID` из `.env`.
- **Клиентская воронка:** согласие на ОПП → сбор ФИО/email/пола → запись → выдача `COURSE_URL`.

---

## 6. Тестирование
1. Запуск в терминале:

   ```bash
   cd ~/<путь-к-репо>
   source .venv/bin/activate
   python lab1/bot/main.py

2 Клиентский сценарий: /start, ввожу данные, получаю ссылку, в leads.csv появилась строка.

3. Админ-сценарии (с аккаунта с ADMIN_TELEGRAM_ID):

/inbox показывает последние заявки.
/find Иван находит тестовую заявку.
/set_status 5 in_work меняет статус.
/export_csv присылает csv, файл открывается в Excel, колонки разнесены корректно.

4 Обработки ошибок:

неверный формат у /set_status = подсказка по формату;
пустая выборка у /find и /inbox = вежливое сообщение;
проверки на доступ к админским командам.

## 7. Видео-демо

Доступно по ссылке: https://drive.google.com/file/d/1z4ztHW1SJgrlvKshox9MGEaEnbqGjQ7D/view?usp=sharing

## 8. Промпт-инжиниринг

Работал по методичке ЛР2: «Выбрать тип интеграции, составить промпт, сгенерировать код, протестировать, улучшить». 

## 9. Результаты
- Реализован полностью рабочий телеграм-бот на Python.  
- Пользователь проходит пошаговую форму с кнопками.  
- Заявки сохраняются в CSV и экспортируются администратору.  
- Все команды работают корректно: `/start`, `/inbox`, `/find`, `/set_status`, `/export`.  
- Файл открывается в Excel по столбцам, поддерживает кириллицу.

---

## 10. Вывод
В ходе работы был создан функциональный Telegram-бот для сбора заявок и администрирования. Реализованы сценарии общения, хранение данных и экспорт в Excel. Цель лабораторной работы достигнута.

## 11. Скриншоты

**Скрин 1.** Структура проекта и файл `.env`  
![Структура проекта](media/s_1.png)

---

### 2. Запуск и инициализация бота
Бот запускается без ошибок, выполняется регистрация команд и подключение к API Telegram.

**Скрин 2.** Успешный запуск бота  
![Запуск бота](media/s_2.png)

---

### 3. Основной сценарий взаимодействия с пользователем
При старте бот показывает клавиатуру с согласием на обработку данных, далее просит ввести ФИО, выбрать пол и указать email. После сохранения отправляет финальную ссылку на курс.

**Скрин 3.** Диалог с ботом  
![Диалог](media/s_3.png)

**Скрин 4.** Финальное сообщение с ссылкой  
![Финальная ссылка](media/s_4.png)

---

### 4. Проверка сохранения данных
После заполнения анкеты информация сохраняется в `lab2/data/leads.csv`.  
Столбцы разделены `;`, кодировка `utf-8-sig`, файл корректно открывается в Excel.

**Скрин 5.** Структура CSV-файла в терминале  
![CSV в терминале](media/s_5.png)

---

### 5. Админ-функции бота
Доступны команды `/inbox`, `/find`, `/set_status`, `/export`.  
Админ может просматривать заявки, искать по имени/email, изменять статус и выгружать таблицу.

**Скрин 6.** Команда `/inbox`  
![inbox](media/s_6.png)

**Скрин 7.** Команда `/find Иван`  
![find](media/s_7.png)

**Скрин 8.** Команда `/set_status 2 done`  
![set_status](media/s_8.png)

---

### 6. Экспорт заявок в CSV и Excel
Бот формирует выгрузку и отправляет файл администратору.  
Файл открывается в Excel с корректным разделением по столбцам и отображением кириллицы.

**Скрин 9.** Команда `/export` — отправка файла  
![export](media/s_9.png)

**Скрин 10.** Открытый файл выгрузки в Excel  
![Excel](media/s_10.png)

![Excel1](media/s_11.png)

![Excel2](media/s_12.png)


